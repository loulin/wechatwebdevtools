"use strict";function init(){function e(e){i.showTipsMsg({msg:e,type:"error"})}var t,r=require("../../lib/react.js"),s=require("../../cssStr/cssStr.js"),i=(require("../../actions/webviewActions.js"),require("../../actions/windowActions.js")),o=(require("../../actions/projectActions.js"),require("../../weapp/utils/tools.js")),n=require("glob"),a=require("fs"),c=require("path"),p=require("url"),u=require("rmdir"),f={},d=[],h=r.createClass({displayName:"Edit",getInitialState:function(){return{project:this.props.project}},onMessage:function(e){var r=this,s=e.command,i=e.msg,h=e.ext,m=this.state.project;switch(console.log("edit.js ",e),s){case"GET_FILE_LIST":var l=i.options,g=l.ignore||[];n("**",{cwd:m.projectpath,ignore:g},function(e,s){for(var i={ret:e?e.toString():0,res:e?[]:s},o=0;o<s.length;o++){var n=s[o],p=c.join(m.projectpath,n),u=a.lstatSync(p),l=u.isDirectory();l&&(s[o]=n+"/")}r.postMessage("webframe","RETURN_RES",i,h),t&&(t.close(),f={},d=[]),d=s,t=a.watch(m.projectpath,{recursive:!0},function(e,t){t=t.replace(/\\/g,"/");var s=c.join(m.projectpath,t),i=a.existsSync(s),o=d.findIndex(function(e){return e===t});if(o===-1&&(e="add",d.push(t)),i){var n=a.lstatSync(s),p=+n.mtime;if(f[s]===p)return;"add"===e&&n.isDirectory()&&(e="addDir"),f[s]=p}else e="delete",d.splice(o,1);var u={eventType:e,fileName:t};r.postMessage("webframe","FILE_CHANGE",u,{})})});break;case"GET_FILE_DATA":var v=i.path,E=c.extname(v);if(".jpg"===E||".png"===E||".jpeg"===E||"icon"===E)return void this.postMessage("webframe","RETURN_RES",{ret:"0",res:p.resolve(o.getBaseURL(m),v)},h);a.readFile(c.join(m.projectpath,v),"utf8",function(e,t){var s={ret:e?e.toString():0,res:e?"":t};r.postMessage("webframe","RETURN_RES",s,h)});break;case"SAVE_FILE_DATA":var R=c.join(m.projectpath,i.path),b=i.data,S=void 0;try{a.writeFileSync(R,b,"utf8")}catch(w){return S={ret:w.toString(),res:""},void this.postMessage("webframe","RETURN_RES",S,h)}S={ret:0,res:i.path};var y=a.lstatSync(R),j=+y.mtime;f[R]=j,this.postMessage("webframe","RETURN_RES",S,h);break;case"DEL_FILE":var _=function(){var e=i.path;return a.unlink(c.join(m.projectpath,e),function(t){var s={ret:t?t.toString():0,res:t?"":e};r.postMessage("webframe","RETURN_RES",s,h)}),"break"}();if("break"===_)break;case"RENAME_FILE":var M=function(){var e=c.join(m.projectpath,i.oldPath),t=c.join(m.projectpath,i.newPath);if(a.existsSync(t)){var s={ret:i.newPath+" 已存在",res:i.newPath+" 已存在"};return r.postMessage("webframe","RETURN_RES",s,h),{v:void 0}}return a.rename(e,t,function(e){var s={ret:e?e.toString():0,res:e?"":t};r.postMessage("webframe","RETURN_RES",s,h)}),"break"}();switch(M){case"break":break;default:if("object"===("undefined"==typeof M?"undefined":_typeof(M)))return M.v}case"RM_DIR":var T=c.join(m.projectpath,i.path);u(T,function(e,t,s){var i={ret:e?e.toString():0,res:e?"":t};r.postMessage("webframe","RETURN_RES",i,h)});break;case"ADD_FILE":var N=c.join(m.projectpath,i.path),k=a.existsSync(N),U=void 0;if(k)U={ret:i.path+" already existed"},this.postMessage("webframe","RETURN_RES",U,h);else{try{a.writeFileSync(N,"","utf8")}catch(w){return U={ret:w.toString(),res:""},void this.postMessage("webframe","RETURN_RES",U,h)}U={ret:0,res:i.path};var A=a.lstatSync(N),L=+A.mtime;f[N]=L,this.postMessage("webframe","RETURN_RES",U,h)}break;case"MAKE_DIR":var D=function(){var e=c.join(m.projectpath,i.path);return a.mkdir(e,function(t){var s={ret:t?t.toString():0,res:t?"":e};r.postMessage("webframe","RETURN_RES",s,h)}),"break"}();if("break"===D)break;case"GET_PROJECT_INFO":this.postMessage("webframe","RETURN_RES",{ret:0,res:m},h)}},postMessage:function(e,t,r,s){var i=this,o={to:e,msg:r,command:t,ext:s};return this.port?(this.msgQuery.length&&(this.msgQuery.forEach(function(e){i.port.postMessage(e)}),this.msgQuery=[]),void this.port.postMessage(o)):void this.msgQuery.push(o)},initport:function(e){var t=this;"edit"===e.name&&(this.port=e,this.port.onMessage.addListener(this.onMessage),this.port.onDisconnect.addListener(function(){t.port.onMessage.removeListener(t.onMessage),delete t.port,delete t.portID,t.msgQuery=[]}),this.postMessage("contentscript","SHAKE_HANDS",{}))},initRuntime:function(){chrome.runtime.onConnect.addListener(this.initport)},addContentScripts:function(){this.webview.addContentScripts([{name:"contentscript",matches:["<all_urls>"],js:{files:["app/dist/contentscript/editcontent.js"]},run_at:"document_start"}])},componentDidMount:function(){this.msgQuery=[];var t=this.refs.container,r=this.webview=document.createElement("webview");r.className="simulator-bd-webview_body",r.setAttribute("partition","persist:trusted"),r.setUserAgentOverride(r.getUserAgent()+" devtoolsedit"),t.appendChild(r),this.addContentScripts(),this.initRuntime(),r.addEventListener("dialog",function(t){var r=t.messageType||"",s=t.messageText;if("alert"===r)e(s);else if("confirm"===r){var i=confirm(s);i?t.dialog.ok():t.dialog.cancel()}else if("prompt"===r){var o=prompt(s);null!==o?t.dialog.ok(o):t.dialog.cancel()}}),r.src="app/html/edit.html"},componentWillUnmount:function(){chrome.runtime.onConnect.removeListener(this.initport),this.webview.remove()},render:function(){var e=this.props,t=e.show,i=(e.project,"edit"===t?{}:s.displayNone);return r.createElement("div",{className:"edit",ref:"container",style:i})}});_exports=h}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_exports;init(),module.exports=_exports;